#
# Starlings
# Copyright (C) 2015 Bull S.A.S. - All rights reserved
#

tosca_definitions_version: janus_tosca_simple_yaml_1_0
description: Kibana is a dashboard for ElasticSearch
template_name: kibana-types
template_version: 2.1
template_author: Atos


node_types:
  starlings.nodes.Kibana:
    derived_from: tosca.nodes.Root
    description: Installation of the Kibana module from ELK stack
    tags:
      icon: /images/kibana-icon.png
    attributes:
      url: { concat: ["http://", get_attribute: [HOST, public_ip_address], ":5601/#/dashboard" ] }
    properties:
      component_version:
        type: version
        description: Version of the installed Kibana component
        default: 4.5.4
        constraints:
          - equal: 4.5.4
      repository:
        type: string
        description: >
          This property give the opportunity to specify an alternative download repository for this component artifacts.
          It is your responsibility to provide an accessible download url and to store required artifacts on it.
          You should specify only the base repository url. Artifacts names will be appended to it, so this property could be shared among
          several components using the inputs feature.
        required: false
        constraints:
          - pattern: ^(http|https|ftp)://.+/.*$
      es_heap_size:
        type: string
        default: "1G"
        description: >
          This property allows to set the heap memory size that is allocated to Elasticsearch client node java process,
          It allocates the same value to both initial and maximum values (ie -Xms and -Xmx java options).
        constraints:
          - pattern: "[1-9][0-9]*[kKmMgG]"
    capabilities:
      dashboard_host:
        type: starlings.capabilities.DashboardHosting
        valid_node_types: [ starlings.nodes.Kibana_Dashboard ]
        upper_bound: unbounded
    requirements:
      - search_endpoint: starlings.capabilities.SearchEndpoint
        relationship_type: starlings.relationships.ConnectsKibanaToElasticsearch
        lower_bound: 1
        upper_bound: 1
      - java: starlings.capabilities.JavaHosting
        type: starlings.relationships.HostedOnJavaRuntime
        lower_bound: 1
        upper_bound: 1
      - consul: starlings.capabilities.ConsulAgent
        type: starlings.relationships.ConnectsToConsulAgent
        lower_bound: 0
        upper_bound: 1
    interfaces:
      Standard:
        create:
          inputs:
            KBN_VERSION: { get_property: [SELF, component_version] }
            REPOSITORY: { get_property: [SELF, repository] }
          implementation: scripts/kibana_install.sh
        start:
          inputs:
            ELASTICSEARCH_HEAP_SIZE: { get_property: [SELF, es_heap_size] }
          implementation: scripts/kibana_start.sh
        stop:
          implementation: scripts/kibana_stop.sh
      custom:
        importDashboardOnKibana:
          inputs:
            url:
              type: string
              required: true
          implementation: scripts/importDashboardOnKibana.sh
    artifacts:
      - scripts: scripts
        type: tosca.artifacts.File
      - utils_scripts: utils_scripts
        type: tosca.artifacts.File
      - consul_utils: consul_utils
        type: tosca.artifacts.File
      - plugins: plugins
        type: tosca.artifacts.File

  starlings.nodes.KibanaDashboard:
    derived_from: tosca.nodes.Root
    description: The abstract dashboard element hosted on Kibana
    tags:
      icon: /images/chart-icon.png
    requirements:
      - dashboard_host: starlings.capabilities.DashboardHosting
        relationship_type: starlings.relationships.DashboardHostedOnKibana
        lower_bound: 1
        upper_bound: 1
    interfaces:
      custom:
        updateDashboardFile:
          inputs:
            dashboard_url:
              type: string
              description: url of the dashboard to upload to update the current one
              required: true
          implementation: scripts/updateDashboardFile.sh
    artifacts:
      - scripts: scripts
        type: tosca.artifacts.File
      - utils_scripts: utils_scripts
        type: tosca.artifacts.File
      - dashboard_file: dashboardFiles/kdb_default.json
        type: starlings.artifacts.Dashboard

  starlings.nodes.BeatsDashboards:
    derived_from: tosca.nodes.Root
    description: The abstract dashboard element hosted on Kibana
    tags:
      icon: /images/chart-icon.png
    requirements:
      - dashboard_host: starlings.capabilities.DashboardHosting
        relationship_type: starlings.relationships.BeatsDashboardsHostedOnKibana
        lower_bound: 1
        upper_bound: 1
    interfaces:
      Standard:
        create: scripts/load-beats-dashboards.sh
    artifacts:
      - utils_scripts: utils_scripts
        type: tosca.artifacts.File
      - dashboards_zip: dashboardFiles/beats-dashboards-1.2.3.zip
        type: tosca.artifacts.File

relationship_types:
  starlings.relationships.ConnectsKibanaToElasticsearch:
    derived_from: tosca.relationships.ConnectsTo
    description: Connects Kibana to Elasticsearch
    valid_sources: [ starlings.capabilities.SearchEndpoint ]
    valid_targets: [ starlings.capabilities.SearchEndpoint ]
    interfaces:
      Configure:
        pre_configure_source:
          implementation: scripts/kibana-to-elasticsearch.sh
          inputs:
            cluster_name: { get_property: [ TARGET, cluster_name ] }
            kibanaIp: { get_attribute: [ SOURCE, ip_address] }
            elasticsearchIp: { get_attribute: [ TARGET, ip_address] }
            REPOSITORY: { get_property: [SOURCE, repository] }
    artifacts:
      - scripts: scripts
        type: tosca.artifacts.File
      - utils_scripts: utils_scripts
        type: tosca.artifacts.File

  starlings.relationships.DashboardHostedOnKibana:
    derived_from: tosca.relationships.HostedOn
    description: Relationship that allows to deploy a dashboard on kibana.
    valid_sources: [ starlings.capabilities.DashboardHosting ]
    valid_targets: [ starlings.capabilities.DashboardHosting ]
    interfaces:
      configure:
        post_configure_source:
          implementation: scripts/dashboardHostedOnKibana_post_configure_source.sh
    artifacts:
      - scripts: scripts
        type: tosca.artifacts.File
      - utils_scripts: utils_scripts
        type: tosca.artifacts.File

  starlings.relationships.BeatsDashboardsHostedOnKibana:
    derived_from: tosca.relationships.HostedOn
    description: Relationship that allows to deploy beats dashboards on Kibana.
    valid_targets: [ starlings.capabilities.DashboardHosting ]

capability_types:
  starlings.capabilities.DashboardHosting:
    derived_from: tosca.capabilities.Container

artifact_types:
  starlings.artifacts.Dashboard:
    description: A Kibana dashboard file (.json file)
    file_ext: [json]
