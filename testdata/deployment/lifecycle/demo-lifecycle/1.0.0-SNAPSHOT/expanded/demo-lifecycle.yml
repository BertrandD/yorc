tosca_definitions_version: tosca_simple_yaml_1_0_0_wd03

template_name: demo-lifecycle
template_author: Alien4cloud
template_version: 1.0.0-SNAPSHOT

imports:
  - normative-types: <normative-types.yml>
  - apache-type:2.0.0-SNAPSHOT
  - php-type:2.0.0-SNAPSHOT

description: Generic type that echoes operations in a file for tests.

# TODO: apache port sttribute should be used by RegistryConfigurer, and Generic & GenericHost

node_types:
  alien.nodes.Registry:
    description: |
      Few PHP scripts that act as a registry for node and relationship operations.
      Logs are stored in files and restituted by index.php.
    derived_from: tosca.nodes.SoftwareComponent
    attributes:
      host: { get_attribute: [HOST, ip_address] }
      port: { get_property: [HOST, port] }
      url: { concat: ["http://", get_attribute: [HOST, public_ip_address], ":", get_property: [HOST, port] ] }
    requirements:
      - host: alien.capabilities.ApacheContainer
        type: alien.relationships.RegistryHostedOnApache
      - php: alien.capabilities.PHPModule
        type: alien.relationships.RegistryConnectToPHP
    interfaces:
      Standard:
        create: scripts/Registry/create.sh
        start: scripts/Registry/start.sh
    artifacts:
      - php_scripts: php
        type: tosca.artifacts.File
  alien.nodes.RegistryConfigurer:
    description: |
      Put this node on each compute you want to log operations. This component
      will just add an entry in /etc/hosts in order to connect to the registry.
    derived_from: tosca.nodes.SoftwareComponent
    requirements:
      - registry: alien.nodes.Registry
        type: alien.relationships.RegistryConfigurerDependsOnRegistry
  alien.nodes.GenericHost:
    description: |
      A software component that hosts Generic.
    derived_from: tosca.nodes.SoftwareComponent
    capabilities:
      host:
        type: tosca.capabilities.Container
    interfaces:
      Standard:
        create:
          implementation: scripts/Generic/create.sh
        configure:
          inputs:
            IP_ADDR: { get_attribute: [SELF, ip_address] }
          implementation: scripts/Generic/configure.sh
        start:
          implementation: scripts/Generic/start.sh
        stop:
          implementation: scripts/Generic/stop.sh
        delete:
          implementation: scripts/Generic/delete.sh
  alien.nodes.Generic:
    description: |
      A software component hosted on GenericHost and that can connect to many other Generic.
    derived_from: tosca.nodes.SoftwareComponent
    capabilities:
      generic_capability:
        type: alien.capabilities.GenericCapability
        upper_bound: unbounded
    requirements:
      - host: tosca.capabilities.Container
        type: alien.relationships.GenericHostedOnGenericHost
        lower_bound: 1
        upper_bound: 1
      - generic_requirement: alien.capabilities.GenericCapability
        type: alien.relationships.GenericConnectToGeneric
        lower_bound: 0
        upper_bound: unbounded
    interfaces:
      Standard:
        create:
          implementation: scripts/Generic/create.sh
        configure:
          implementation: scripts/Generic/configure.sh
        start:
          implementation: scripts/Generic/start.sh
        stop:
          implementation: scripts/Generic/stop.sh
        delete:
          implementation: scripts/Generic/delete.sh

relationship_types:
  alien.relationships.RegistryHostedOnApache:
    derived_from: tosca.relationships.HostedOn
    valid_sources: [ alien.nodes.Registry ]
    valid_targets: [ alien.capabilities.ApacheContainer ]
  alien.relationships.RegistryConnectToPHP:
    derived_from: tosca.relationships.ConnectsTo
    valid_sources: [ alien.nodes.Registry ]
    valid_targets: [ alien.capabilities.PHPModule ]
  alien.relationships.RegistryConfigurerDependsOnRegistry:
    derived_from: tosca.relationships.DependsOn
    valid_sources: [ alien.nodes.RegistryConfigurer ]
    valid_targets: [ tosca.capabilities.Node ]
    interfaces:
      Configure:
        add_target:
          inputs:
            REGISTRY_HOST: { get_attribute: [TARGET, host] }
            REGISTRY_PORT: { get_attribute: [TARGET, port] }
          implementation: scripts/RegistryConfigurerDependsOnRegistry/add_target.sh
  alien.relationships.GenericHostedOnGenericHost:
    derived_from: tosca.relationships.HostedOn
    valid_sources: [ alien.nodes.Generic ]
    valid_targets: [ alien.nodes.GenericHost ]
    interfaces:
      Configure:
        pre_configure_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/pre_configure_source.sh
        pre_configure_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/pre_configure_target.sh
        post_configure_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/post_configure_source.sh
        post_configure_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/post_configure_target.sh
        add_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/add_target.sh
        add_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/add_source.sh
        remove_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/remove_target.sh
        remove_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/remove_source.sh
  alien.relationships.GenericConnectToGeneric:
    derived_from: tosca.relationships.ConnectsTo
    valid_sources: [ alien.capabilities.GenericCapability ]
    valid_targets: [ alien.capabilities.GenericCapability ]
    interfaces:
      Configure:
        pre_configure_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/pre_configure_source.sh
        pre_configure_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/pre_configure_target.sh
        post_configure_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/post_configure_source.sh
        post_configure_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/post_configure_target.sh
        add_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/add_target.sh
        add_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/add_source.sh
        remove_target:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/remove_target.sh
        remove_source:
          inputs:
            TARGET_IP: { get_attribute: [TARGET, ip_address] }
            SOURCE_IP: { get_attribute: [SOURCE, ip_address] }
          implementation: scripts/GenericConnectToGeneric/remove_source.sh

capability_types:
  alien.capabilities.GenericCapability:
    derived_from: tosca.capabilities.Root
